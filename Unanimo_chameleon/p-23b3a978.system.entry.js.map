{"version":3,"names":["THEMES","Map","BASEURL_REGEX","isEnabledTheme","theme","styleSheet","disabled","instanceTheme","el","addThemeElement","attachTheme","setLoadedTheme","loadTheme","then","loaded","enableTheme","attachAllTheme","setLoadedAllTheme","removeThemeElement","get","name","index","elements","indexOf","removeElement","_a","set","push","href","trim","some","item","appendThemeStyleSheetUrl","getThemeStyleSheet","baseUrl","sent","innerText","match","appendThemeStyleSheetText","CSSStyleSheet","baseURL","root","getRootNode","Document","ShadowRoot","adoptedStyleSheets","includes","forEach","cssText","_this","this","Promise","resolve","__awaiter","appendCssText","applyBaseUrl","error","url","_b","_d","requestStyleSheet","apply","_c","concat","_e","_f","fetch","response","ok","text","Error","error_2","themeStyleSheet","replace","parserStyleSheet","_i","cssRules","length","cssRule","insertRule","ChTheme","exports","class_1","prototype","loadedHandler","themeLoaded","emit","connectedCallback","hidden","componentWillLoad","disconnectedCallback"],"sources":["src/components/theme/theme-stylesheet.ts","src/components/theme/theme.tsx"],"sourcesContent":["import { removeElement } from \"../../common/array\";\r\n\r\nconst THEMES = new Map<string, Theme>();\r\nconst BASEURL_REGEX =\r\n  /(url\\((?!\\s*[\"']?(?:\\/|https?:|data:))\\s*[\"']?)([^'\")]+)/g;\r\n\r\ntype Theme = {\r\n  elements: HTMLChThemeElement[];\r\n  styleSheet?: CSSStyleSheet;\r\n};\r\n\r\n/**\r\n * Event interface for when a theme is loaded.\r\n */\r\nexport interface ChThemeLoadedEvent {\r\n  name: string;\r\n}\r\n\r\nconst isEnabledTheme = (theme: Theme): boolean =>\r\n  theme.styleSheet ? !theme.styleSheet.disabled : false;\r\n\r\n/**\r\n * Initializes a theme instance within the Document or ShadowRoot to which the HTMLChThemeElement belongs.\r\n * If the HTMLChThemeElement indicates the source of the theme, it loads the theme.\r\n */\r\nexport function instanceTheme(el: HTMLChThemeElement) {\r\n  const theme = addThemeElement(el);\r\n\r\n  /**\r\n   * If the theme is already loaded and enabled,\r\n   * just attach it and mark as loaded in HTMLChThemeElement context\r\n   */\r\n  if (isEnabledTheme(theme)) {\r\n    attachTheme(el, theme);\r\n    setLoadedTheme(el);\r\n    return;\r\n  }\r\n\r\n  /**\r\n   * Otherwise, load the theme asynchronously,\r\n   * then attach it and mark as loaded in all HTMLChThemeElement contexts\r\n   */\r\n  loadTheme(el, theme).then(loaded => {\r\n    if (loaded) {\r\n      enableTheme(theme);\r\n      attachAllTheme(theme);\r\n      setLoadedAllTheme(theme);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Removes a theme element.\r\n * @param el The HTMLChThemeElement to remove the theme from.\r\n */\r\nexport function removeThemeElement(el: HTMLChThemeElement) {\r\n  const theme = THEMES.get(el.name);\r\n  const index = theme.elements.indexOf(el);\r\n\r\n  if (theme && index >= 0) {\r\n    removeElement(theme.elements, index);\r\n  }\r\n}\r\n\r\nfunction addThemeElement(el: HTMLChThemeElement): Theme {\r\n  const theme =\r\n    THEMES.get(el.name) ?? THEMES.set(el.name, { elements: [] }).get(el.name);\r\n\r\n  theme.elements.push(el);\r\n\r\n  return theme;\r\n}\r\n\r\nasync function loadTheme(\r\n  el: HTMLChThemeElement,\r\n  theme: Theme\r\n): Promise<boolean> {\r\n  let loaded = false;\r\n\r\n  if (\r\n    typeof el.href === \"string\" &&\r\n    el.href.trim() !== \"\" &&\r\n    !theme.elements.some(item => item !== el && item.href === el.href)\r\n  ) {\r\n    loaded = await appendThemeStyleSheetUrl(\r\n      el.href,\r\n      getThemeStyleSheet(el, theme),\r\n      el.baseUrl\r\n    );\r\n  } else if (!el.innerText.match(/^\\s*$/)) {\r\n    loaded = await appendThemeStyleSheetText(\r\n      el.innerText,\r\n      getThemeStyleSheet(el, theme),\r\n      el.baseUrl\r\n    );\r\n  }\r\n\r\n  return loaded;\r\n}\r\n\r\nfunction getThemeStyleSheet(el: HTMLChThemeElement, theme: Theme) {\r\n  theme.styleSheet ||= new CSSStyleSheet({\r\n    disabled: true,\r\n    baseURL: el.baseUrl\r\n  });\r\n\r\n  return theme.styleSheet;\r\n}\r\n\r\nfunction attachTheme(el: HTMLChThemeElement, theme: Theme) {\r\n  const root = el.getRootNode();\r\n\r\n  if (root instanceof Document || root instanceof ShadowRoot) {\r\n    if (!root.adoptedStyleSheets.includes(theme.styleSheet)) {\r\n      root.adoptedStyleSheets.push(theme.styleSheet);\r\n    }\r\n  }\r\n}\r\n\r\nfunction attachAllTheme(theme: Theme) {\r\n  theme.elements.forEach(el => attachTheme(el, theme));\r\n}\r\n\r\nfunction enableTheme(theme: Theme) {\r\n  theme.styleSheet.disabled = false;\r\n}\r\n\r\nfunction setLoadedTheme(el: HTMLChThemeElement) {\r\n  el.loaded = true;\r\n}\r\n\r\nfunction setLoadedAllTheme(theme: Theme) {\r\n  theme.elements.forEach(el => setLoadedTheme(el));\r\n}\r\n\r\nfunction appendThemeStyleSheetText(\r\n  cssText: string,\r\n  styleSheet: CSSStyleSheet,\r\n  baseUrl: string\r\n): Promise<boolean> {\r\n  return new Promise(async resolve => {\r\n    try {\r\n      resolve(appendCssText(styleSheet, applyBaseUrl(baseUrl, cssText)));\r\n    } catch (error) {\r\n      resolve(false);\r\n    }\r\n  });\r\n}\r\n\r\nasync function appendThemeStyleSheetUrl(\r\n  url: string,\r\n  styleSheet: CSSStyleSheet,\r\n  baseUrl: string\r\n): Promise<boolean> {\r\n  return new Promise(async resolve => {\r\n    try {\r\n      resolve(\r\n        appendCssText(\r\n          styleSheet,\r\n          applyBaseUrl(baseUrl, await requestStyleSheet(url))\r\n        )\r\n      );\r\n    } catch (error) {\r\n      resolve(false);\r\n    }\r\n  });\r\n}\r\n\r\nasync function requestStyleSheet(url: string): Promise<string> {\r\n  try {\r\n    const response = await fetch(url);\r\n    if (response.ok) {\r\n      return await response.text();\r\n    }\r\n    throw new Error(\"Network response was not ok.\");\r\n  } catch (error) {\r\n    throw error;\r\n  }\r\n}\r\n\r\nfunction appendCssText(\r\n  themeStyleSheet: CSSStyleSheet,\r\n  cssText: string\r\n): Promise<boolean> {\r\n  return new Promise(async resolve => {\r\n    try {\r\n      const parserStyleSheet = await new CSSStyleSheet({\r\n        disabled: true\r\n      }).replace(cssText);\r\n\r\n      for (const cssRule of parserStyleSheet.cssRules) {\r\n        themeStyleSheet.insertRule(cssRule.cssText);\r\n      }\r\n\r\n      resolve(true);\r\n    } catch (error) {\r\n      resolve(false);\r\n    }\r\n  });\r\n}\r\n\r\nfunction applyBaseUrl(baseUrl: string, cssText: string): string {\r\n  if (baseUrl) {\r\n    return cssText.replace(BASEURL_REGEX, `$1${baseUrl}$2`);\r\n  }\r\n  return cssText;\r\n}\r\n","import {\r\n  Component,\r\n  Element,\r\n  Event,\r\n  EventEmitter,\r\n  Prop,\r\n  Watch\r\n} from \"@stencil/core\";\r\nimport {\r\n  ChThemeLoadedEvent,\r\n  instanceTheme,\r\n  removeThemeElement\r\n} from \"./theme-stylesheet\";\r\n\r\n/**\r\n * It allows you to load a style sheet in a similar way to the\r\n * native LINK or STYLE tags, but assigning it a name so that\r\n * it can be reused in different contexts,\r\n * either in the Document or in a Shadow-Root.\r\n */\r\n@Component({\r\n  tag: \"ch-theme\"\r\n})\r\nexport class ChTheme {\r\n  @Element() el: HTMLChThemeElement;\r\n\r\n  /**\r\n   * Specifies the name of the theme to instantiate\r\n   */\r\n  @Prop({ reflect: true }) readonly name: string;\r\n\r\n  /**\r\n   * Specifies the location of the stylesheet theme\r\n   */\r\n  @Prop({ reflect: true }) readonly href: string;\r\n\r\n  /**\r\n   * A string containing the baseURL used to resolve relative URLs in the stylesheet\r\n   */\r\n  @Prop({ reflect: true }) readonly baseUrl: string;\r\n\r\n  /**\r\n   * Indicates whether the theme has successfully loaded\r\n   */\r\n  @Prop() readonly loaded: boolean = false;\r\n  @Watch(\"loaded\")\r\n  loadedHandler() {\r\n    if (this.loaded) {\r\n      this.themeLoaded.emit({ name: this.name ?? \"\" });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Event emitted when the theme has successfully loaded\r\n   */\r\n  @Event({ bubbles: true, composed: false })\r\n  themeLoaded: EventEmitter<ChThemeLoadedEvent>;\r\n\r\n  connectedCallback() {\r\n    this.el.hidden = true;\r\n  }\r\n\r\n  componentWillLoad() {\r\n    instanceTheme(this.el);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    removeThemeElement(this.el);\r\n  }\r\n}\r\n"],"mappings":"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"}